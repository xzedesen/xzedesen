<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Signup | Xzedesen - Verified Social Network</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{background:linear-gradient(135deg,#1a1a2e 0%,#16213e 50%,#0f3460 100%);min-height:100vh;display:flex;justify-content:center;align-items:center;color:#fff;padding:15px;}
    .signup-container{background:rgba(30,30,50,0.95);backdrop-filter:blur(15px);border-radius:16px;box-shadow:0 15px 35px rgba(0,0,0,0.3);width:100%;max-width:480px;padding:30px 25px;text-align:center;border:1px solid rgba(255,255,255,0.15);}
    .logo h1{font-size:2.5rem;font-weight:800;background:linear-gradient(45deg,#ff6b6b,#ff8e53,#ff6b6b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 20px rgba(255,107,107,0.5);margin-bottom:5px;}
    .logo p{color:rgba(255,255,255,0.8);margin-bottom:20px;font-size:0.9rem;}
    .form-group{margin-bottom:15px;text-align:left;}
    .form-group label{display:block;margin-bottom:5px;font-weight:500;font-size:0.9rem;color:rgba(255,255,255,0.9);}
    .form-group input,.form-group select{width:100%;padding:14px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.08);color:#fff;font-size:14px;}
    .form-group input::placeholder{color:rgba(255,255,255,0.5);}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .password-wrapper{position:relative;}
    .password-wrapper i{position:absolute;right:12px;top:50%;transform:translateY(-50%);color:rgba(255,255,255,0.6);cursor:pointer;}
    .file-upload{border:2px dashed rgba(255,255,255,0.3);border-radius:10px;padding:20px;text-align:center;cursor:pointer;}
    .file-upload:hover{border-color:rgba(255,107,107,0.6);background:rgba(255,107,107,0.05);}
    .file-upload i{font-size:1.8rem;color:rgba(255,107,107,0.7);margin-bottom:8px;}
    .preview-container{margin-top:10px;display:none;}
    .preview-image{max-width:120px;max-height:120px;border-radius:8px;border:2px solid rgba(255,107,107,0.5);}
    .signup-btn,.back-btn{width:100%;padding:16px;margin-top:15px;background:linear-gradient(45deg,#ff6b6b,#ff8e53);border:none;border-radius:10px;color:white;font-size:16px;font-weight:600;cursor:pointer;transition:all 0.3s ease;}
    .signup-btn:hover:not(:disabled),.back-btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(255,107,107,0.4);}
    .signup-btn:disabled{background:rgba(255,255,255,0.2);cursor:not-allowed;opacity:0.6;}
    .error-message{color:#ff6b6b;font-size:13px;margin-top:8px;min-height:16px;text-align:center;}
  </style>
</head>
<body>
  <div class="signup-container">
    <div class="logo">
      <h1>Xzedesen</h1>
      <p>Join the verified elite community</p>
    </div>

    <form id="signupForm">
      <!-- Username -->
      <div class="form-group">
        <label for="username">Username*</label>
        <input type="text" id="username" required placeholder="yourname">
        <div id="usernameStatus" style="font-size:12px;margin-top:3px;"></div>
      </div>

      <!-- Password + Retype -->
      <div class="row">
        <div class="form-group password-wrapper">
          <label for="password">Password*</label>
          <input type="password" id="password" required minlength="6" placeholder="Enter password">
          <i class="fas fa-eye togglePass" data-target="password"></i>
        </div>
        <div class="form-group password-wrapper">
          <label for="repassword">Retype Password*</label>
          <input type="password" id="repassword" required minlength="6" placeholder="Retype password">
          <i class="fas fa-eye togglePass" data-target="repassword"></i>
        </div>
      </div>

      <!-- Full name -->
      <div class="form-group">
        <label for="fullname">Full Name*</label>
        <input type="text" id="fullname" required placeholder="Enter your full name">
      </div>

      <!-- Gender + DOB -->
      <div class="row">
        <div class="form-group">
          <label for="gender">Gender*</label>
          <select id="gender" required>
            <option value="">Select Gender</option>
            <option>Male</option><option>Female</option><option>Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="dob">Date of Birth*</label>
          <input type="date" id="dob" required>
        </div>
      </div>

      <!-- State + City -->
      <div class="row">
        <div class="form-group">
          <label for="state">State*</label>
          <select id="state" required></select>
        </div>
        <div class="form-group">
          <label for="city">City*</label>
          <select id="city" required></select>
        </div>
      </div>

      <!-- Profile pic -->
      <div class="form-group">
        <label>Upload Profile Picture*</label>
        <div class="file-upload" id="uploadBox">
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Click to upload photo</p>
          <p style="font-size:11px;opacity:0.7;">Max size: 5MB</p>
          <input type="file" id="selfie" accept="image/*" hidden required>
        </div>
        <div class="preview-container" id="previewContainer">
          <img id="previewImage" class="preview-image" alt="Preview">
        </div>
      </div>

      <div id="signupError" class="error-message"></div>
      <button type="submit" class="signup-btn" id="signupBtn" disabled>
        <i class="fas fa-user-plus"></i> CREATE VERIFIED ACCOUNT
      </button>
    </form>
    <button onclick="window.location.href='index.html'" class="back-btn">⬅ Back to Login</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDEBKGAsMF8woHBpOY5OK4isHGA_anAEPs",
      authDomain: "xzedesen-916ea.firebaseapp.com",
      projectId: "xzedesen-916ea",
      storageBucket: "xzedesen-916ea.appspot.com",
      messagingSenderId: "1019829731381",
      appId: "1:1019829731381:web:e987812821dd660578317c"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const usernameInput = document.getElementById("username");
    const usernameStatus = document.getElementById("usernameStatus");
    const signupBtn = document.getElementById("signupBtn");
    const signupError = document.getElementById("signupError");
    const passwordInput = document.getElementById("password");
    const repasswordInput = document.getElementById("repassword");
    const stateSel = document.getElementById("state");
    const citySel = document.getElementById("city");
    const selfieInput = document.getElementById("selfie");
    const previewContainer = document.getElementById("previewContainer");
    const previewImage = document.getElementById("previewImage");

    let isUsernameAvailable = false;

    // Real-time password mismatch check
    function checkPasswordMatch() {
      const p = passwordInput.value;
      const rp = repasswordInput.value;
      if (p && rp && p !== rp) {
        signupError.textContent = "Passwords do not match";
        return false;
      }
      signupError.textContent = "";
      return true;
    }

    // Username check
    usernameInput.addEventListener("input", async () => {
      const uname = usernameInput.value.trim();
      if (uname.length < 3) {
        usernameStatus.textContent = "Min 3 chars";
        isUsernameAvailable = false;
      } else {
        try {
          const q = query(collection(db, "users"), where("username", "==", uname));
          const snap = await getDocs(q);
          if (snap.empty) {
            usernameStatus.textContent = `✓ ${uname}@xzedesen.com is available`;
            isUsernameAvailable = true;
          } else {
            usernameStatus.textContent = `✗ ${uname}@xzedesen.com is taken`;
            isUsernameAvailable = false;
          }
        } catch (err) {
          usernameStatus.textContent = "Error checking username";
          console.error("Username check error:", err);
        }
      }
      updateBtn();
    });

    // Password inputs real-time check
    passwordInput.addEventListener("input", checkPasswordMatch);
    repasswordInput.addEventListener("input", checkPasswordMatch);

    // State-City load from cities.json (GitHub raw URL)
    fetch("https://raw.githubusercontent.com/xzedesen/xzedesen/main/cities.json")
      .then(r => {
        if (!r.ok) throw new Error(`HTTP error! Status: ${r.status}`);
        return r.json();
      })
      .then(data => {
        stateSel.innerHTML = '<option value="">Select State</option>';
        for (const st in data) {
          stateSel.innerHTML += `<option>${st}</option>`;
        }
        stateSel.addEventListener("change", () => {
          citySel.innerHTML = '<option value="">Select City</option>';
          if (data[stateSel.value]) {
            data[stateSel.value].forEach(c => citySel.innerHTML += `<option>${c}</option>`);
          }
        });
      })
      .catch(err => {
        signupError.textContent = "Failed to load states/cities. Try again.";
        console.error("Cities fetch error:", err);
      });

    // Photo upload preview
    document.getElementById("uploadBox").addEventListener("click", () => selfieInput.click());
    selfieInput.addEventListener("change", e => {
      const f = e.target.files[0];
      if (!f) return;
      if (f.size > 5 * 1024 * 1024) {
        signupError.textContent = "Image must be less than 5MB";
        selfieInput.value = "";
        return;
      }
      const r = new FileReader();
      r.onload = ev => {
        previewImage.src = ev.target.result;
        previewContainer.style.display = "block";
      };
      r.readAsDataURL(f);
      updateBtn();
    });

    // Show/Hide password
    document.querySelectorAll(".togglePass").forEach(icon => {
      icon.addEventListener("click", () => {
        const t = document.getElementById(icon.dataset.target);
        if (t.type === "password") {
          t.type = "text";
          icon.classList.replace("fa-eye", "fa-eye-slash");
        } else {
          t.type = "password";
          icon.classList.replace("fa-eye-slash", "fa-eye");
        }
      });
    });

    // Enable button
    function updateBtn() {
      const uname = usernameInput.value.trim();
      const p = passwordInput.value;
      const rp = repasswordInput.value;
      const f = document.getElementById("fullname").value;
      const g = document.getElementById("gender").value;
      const d = document.getElementById("dob").value;
      const st = stateSel.value;
      const ct = citySel.value;
      const pic = selfieInput.files[0];
      signupBtn.disabled = !(uname && p && rp && f && g && d && st && ct && pic && isUsernameAvailable && checkPasswordMatch());
    }
    document.querySelectorAll("input,select").forEach(el => el.addEventListener("input", updateBtn));

    // Submit
    document.getElementById("signupForm").addEventListener("submit", async e => {
      e.preventDefault();
      if (!checkPasswordMatch()) return;
      const uname = usernameInput.value.trim();
      const email = uname + "@xzedesen.com";
      const pass = passwordInput.value;
      const fullname = document.getElementById("fullname").value;
      const dob = document.getElementById("dob").value;
      const gender = document.getElementById("gender").value;
      const state = stateSel.value;
      const city = citySel.value;
      const file = selfieInput.files[0];
      try {
        signupBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
        signupBtn.disabled = true;
        const userCred = await createUserWithEmailAndPassword(auth, email, pass);
        const uid = userCred.user.uid;
        const sRef = ref(storage, `users/${uid}/profile.jpg`);
        await uploadBytes(sRef, file);
        const photoURL = await getDownloadURL(sRef);
        await setDoc(doc(db, "users", uid), {
          username: uname,
          fullname,
          dob,
          gender,
          state,
          city,
          photoURL,
          email,
          role: "user",
          isAdmin: false,
          verified: false,
          createdAt: serverTimestamp()
        });
        signupBtn.innerHTML = '<i class="fas fa-check"></i> Account Created!';
        setTimeout(() => window.location.href = "welcome.html", 1500);
      } catch (err) {
        let errorMsg = "Error creating account. Please try again.";
        if (err.code === "auth/email-already-in-use") {
          errorMsg = "Username already taken. Try another.";
        } else if (err.code === "auth/weak-password") {
          errorMsg = "Password too weak. Use 6+ characters.";
        } else if (err.code === "permission-denied") {
          errorMsg = "Firestore permission error. Check rules.";
        } else if (err.code === "auth/invalid-email") {
          errorMsg = "Invalid email format.";
        }
        signupError.textContent = errorMsg;
        console.error("Signup error:", err);
        signupBtn.innerHTML = '<i class="fas fa-user-plus"></i> CREATE VERIFIED ACCOUNT';
        signupBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
