<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";
  import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDEBKGAsMF8woHBpOY5OK4isHGA_anAEPs",
    authDomain: "xzedesen-916ea.firebaseapp.com",
    projectId: "xzedesen-916ea",
    storageBucket: "xzedesen-916ea.firebasestorage.app",
    messagingSenderId: "1019829731381",
    appId: "1:1019829731381:web:e987812821dd660578317c"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // DOM elements
  const stateSelect = document.getElementById("state");
  const cityGroup = document.getElementById("city-group");
  const citySelect = document.getElementById("city");
  const usernameInput = document.getElementById("username");
  const usernamePreview = document.getElementById("usernamePreview");
  const submitBtn = document.getElementById("submitBtn");
  const passwordInput = document.getElementById("password");
  const confirmPasswordInput = document.getElementById("confirmPassword");
  const confirmPasswordError = document.getElementById("confirmPasswordError");
  const passwordToggle = document.getElementById("passwordToggle");
  const confirmPasswordToggle = document.getElementById("confirmPasswordToggle");
  const passwordStrength = document.getElementById("passwordStrength");
  const strengthText = document.getElementById("strengthText");
  const strengthFill = document.getElementById("strengthFill");
  const photoInput = document.getElementById("photo");
  const photoPreview = document.getElementById("photoPreview");
  const defaultIcon = document.querySelector('.default-icon');
  const uploadPhotoBtn = document.getElementById("uploadPhotoBtn");
  const takePhotoBtn = document.getElementById("takePhotoBtn");
  const cameraModal = document.getElementById("cameraModal");
  const cameraVideo = document.getElementById("cameraVideo");
  const cameraCanvas = document.getElementById("cameraCanvas");
  const captureBtn = document.getElementById("captureBtn");
  const closeCamera = document.getElementById("closeCamera");

  let usernameCheckTimeout;
  let isUsernameAvailable = false;
  let isPasswordStrong = false;
  let isPasswordConfirmed = false;
  let userPhoto = null;
  let stream = null;

  // Password toggle functionality
  passwordToggle.addEventListener('click', function() {
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
  });

  confirmPasswordToggle.addEventListener('click', function() {
    const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    confirmPasswordInput.setAttribute('type', type);
    this.innerHTML = type === 'password' ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
  });

  // Password strength checker
  passwordInput.addEventListener('input', function() {
    const password = this.value;
    checkPasswordStrength(password);
    checkPasswordMatch();
  });

  confirmPasswordInput.addEventListener('input', checkPasswordMatch);

  function checkPasswordStrength(password) {
    let strength = 0;

    if (password.length >= 8) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;

    passwordStrength.style.display = 'block';
    
    if (password.length === 0) {
      strengthText.textContent = "Password strength: ";
      strengthFill.style.width = "0%";
      strengthFill.style.background = "transparent";
      isPasswordStrong = false;
      updateSubmitButton();
      return;
    }

    if (strength <= 2) {
      strengthText.textContent = "Password strength: Weak";
      strengthText.className = "strength-weak";
      strengthFill.style.width = "33%";
      strengthFill.style.background = "#ff6b6b";
      isPasswordStrong = false;
    } else if (strength <= 4) {
      strengthText.textContent = "Password strength: Medium";
      strengthText.className = "strength-medium";
      strengthFill.style.width = "66%";
      strengthFill.style.background = "#ff8e53";
      isPasswordStrong = true;
    } else {
      strengthText.textContent = "Password strength: Strong";
      strengthText.className = "strength-strong";
      strengthFill.style.width = "100%";
      strengthFill.style.background = "#4ecdc4";
      isPasswordStrong = true;
    }
    
    updateSubmitButton();
  }

  function checkPasswordMatch() {
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    if (confirmPassword.length === 0) {
      confirmPasswordError.textContent = "";
      isPasswordConfirmed = false;
    } else if (password !== confirmPassword) {
      confirmPasswordError.textContent = "Passwords do not match";
      isPasswordConfirmed = false;
    } else {
      confirmPasswordError.textContent = "";
      isPasswordConfirmed = true;
    }
    
    updateSubmitButton();
  }

  // Photo upload functionality
  uploadPhotoBtn.addEventListener('click', function() {
    photoInput.click();
  });

  photoInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      if (file.size > 5 * 1024 * 1024) {
        alert('File size too large. Please select an image under 5MB.');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        photoPreview.src = e.target.result;
        photoPreview.style.display = 'block';
        defaultIcon.style.display = 'none';
        userPhoto = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  });

  // Camera functionality
  takePhotoBtn.addEventListener('click', function() {
    openCamera();
  });

  closeCamera.addEventListener('click', function() {
    closeCameraModal();
  });

  captureBtn.addEventListener('click', function() {
    capturePhoto();
  });

  function openCamera() {
    cameraModal.style.display = 'flex';
    
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      })
      .then(function(mediaStream) {
        stream = mediaStream;
        cameraVideo.srcObject = stream;
        cameraVideo.play().catch(err => console.warn("Autoplay issue:", err));
      })
      .catch(function(err) {
        console.error("Error accessing camera: ", err);
        alert("Unable to access camera. Please check permissions and try again.");
        closeCameraModal();
      });
    } else {
      alert("Your browser doesn't support camera access.");
      closeCameraModal();
    }
  }

  function closeCameraModal() {
    cameraModal.style.display = 'none';
    
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
  }

  function capturePhoto() {
    const context = cameraCanvas.getContext('2d');
    cameraCanvas.width = cameraVideo.videoWidth;
    cameraCanvas.height = cameraVideo.videoHeight;
    
    context.drawImage(cameraVideo, 0, 0, cameraCanvas.width, cameraCanvas.height);
    
    const photoDataUrl = cameraCanvas.toDataURL('image/jpeg', 0.8);
    
    photoPreview.src = photoDataUrl;
    photoPreview.style.display = 'block';
    defaultIcon.style.display = 'none';
    userPhoto = photoDataUrl;
    
    closeCameraModal();
  }

  // Username availability check
  async function checkUsernameAvailability(username) {
    if (username.length < 3) {
      hideUsernamePreview();
      return;
    }

    showCheckingStatus();
    
    const validationError = validateUsername(username);
    if (validationError) {
      showUsernameError(validationError);
      return;
    }

    const fullUsername = username + "@xzedesen.com";
    
    try {
      const refDoc = doc(db, "users", fullUsername);
      const snap = await getDoc(refDoc);
      
      if (snap.exists()) {
        showUsernameTaken(fullUsername);
      } else {
        showUsernameAvailable(fullUsername);
      }
    } catch (err) {
      showUsernameError("Error checking username availability");
    }
  }

  function showCheckingStatus() {
    usernamePreview.innerHTML = `
      <div class="availability-status">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Checking username availability...</span>
      </div>
    `;
    usernamePreview.className = "username-preview username-checking";
    usernamePreview.style.display = "block";
    isUsernameAvailable = false;
    updateSubmitButton();
  }

  function showUsernameAvailable(fullUsername) {
    usernamePreview.innerHTML = `
      <div class="availability-status">
        <i class="fas fa-check-circle"></i>
        <span>Your username is <strong>${fullUsername}</strong></span>
      </div>
    `;
    usernamePreview.className = "username-preview username-available";
    usernamePreview.style.display = "block";
    isUsernameAvailable = true;
    updateSubmitButton();
  }

  function showUsernameTaken(fullUsername) {
    usernamePreview.innerHTML = `
      <div class="availability-status">
        <i class="fas fa-times-circle"></i>
        <span>Username already taken! <strong>${fullUsername}</strong> is not available</span>
      </div>
    `;
    usernamePreview.className = "username-preview username-taken";
    usernamePreview.style.display = "block";
    isUsernameAvailable = false;
    updateSubmitButton();
  }

  function showUsernameError(error) {
    usernamePreview.innerHTML = `
      <div class="availability-status">
        <i class="fas fa-exclamation-circle"></i>
        <span>${error}</span>
      </div>
    `;
    usernamePreview.className = "username-preview username-taken";
    usernamePreview.style.display = "block";
    isUsernameAvailable = false;
    updateSubmitButton();
  }

  function hideUsernamePreview() {
    usernamePreview.style.display = "none";
    isUsernameAvailable = false;
    updateSubmitButton();
  }

  function updateSubmitButton() {
    submitBtn.disabled = !(isUsernameAvailable && isPasswordStrong && isPasswordConfirmed);
  }

  usernameInput.addEventListener("input", function() {
    const username = this.value.toLowerCase().trim();
    document.getElementById("usernameError").textContent = "";
    
    clearTimeout(usernameCheckTimeout);
    
    if (username.length >= 3) {
      usernameCheckTimeout = setTimeout(() => {
        checkUsernameAvailability(username);
      }, 500);
    } else {
      hideUsernamePreview();
    }
  });

  // üî• Load Indian States
  fetch("https://raw.githubusercontent.com/dr5hn/countries-states-cities-database/master/states.json")
    .then(res => res.json())
    .then(data => {
      const indiaStates = data.filter(state => state.country_code === "IN");
      indiaStates.forEach(state => {
        let opt = document.createElement("option");
        opt.value = state.name;
        opt.textContent = state.name;
        stateSelect.appendChild(opt);
      });
    })
    .catch(err => console.error("Error loading states:", err));

  // üî• Load Cities based on selected State
  stateSelect.addEventListener("change", () => {
    citySelect.innerHTML = "<option value=''>Select city</option>";
    if (stateSelect.value) {
      fetch("https://raw.githubusercontent.com/dr5hn/countries-states-cities-database/master/cities.json")
        .then(res => res.json())
        .then(data => {
          const stateCities = data.filter(city => city.state_name === stateSelect.value);
          stateCities.forEach(city => {
            let opt = document.createElement("option");
            opt.value = city.name;
            opt.textContent = city.name;
            citySelect.appendChild(opt);
          });
          cityGroup.style.display = "block";
        })
        .catch(err => console.error("Error loading cities:", err));
    } else {
      cityGroup.style.display = "none";
    }
  });

  // Gender handling
  document.getElementById("gender").addEventListener("change", e => {
    document.getElementById("otherGenderBox").style.display = 
      e.target.value === "Other" ? "block" : "none";
  });

  function validateUsername(u){
    if(u.length < 5) return "Must be at least 5 characters";
    if(!/[0-9]/.test(u)) return "Must include at least one number";
    if(/\s/.test(u)) return "No spaces allowed";
    if(!/^[a-z0-9.]+$/.test(u)) return "Only letters, numbers & periods allowed";
    if(u.includes(".com")||u.includes(".net")) return "Invalid username";
    return "";
  }

  // Form submission
  document.getElementById("signupForm").addEventListener("submit", async e => {
    e.preventDefault();
    
    if (!isUsernameAvailable) {
      alert("‚ùå Please choose an available username first.");
      return;
    }
    
    if (!isPasswordStrong) {
      alert("‚ùå Please choose a stronger password.");
      return;
    }
    
    if (!isPasswordConfirmed) {
      alert("‚ùå Passwords do not match.");
      return;
    }
    
    let username = document.getElementById("username").value.toLowerCase();
    let fullname = document.getElementById("fullname").value;
    let password = document.getElementById("password").value;
    let gender = document.getElementById("gender").value;
    if(gender === "Other") gender = document.getElementById("otherGenderBox").value;
    let dob = document.getElementById("dob").value;
    let state = stateSelect.value;
    let city = citySelect.value;

    let error = validateUsername(username);
    if(error){
      document.getElementById("usernameError").textContent = error;
      return;
    }
    
    username = username + "@xzedesen.com";

    try {
      const refDoc = doc(db, "users", username);
      const snap = await getDoc(refDoc);
      if(snap.exists()){
        alert("‚ùå Username already taken. Please choose another one.");
        return;
      }
      
      // üî• Upload photo to Firebase Storage
      let photoURL = null;
      if (userPhoto) {
        const photoRef = ref(storage, `users/${username}/profile.jpg`);
        await uploadString(photoRef, userPhoto, 'data_url');
        photoURL = await getDownloadURL(photoRef);
      }

      // Save to Firestore
      await setDoc(refDoc, {
        fullname,
        password, // ‚ö†Ô∏è Future me hash karna hai
        gender,
        dob,
        state,
        city,
        photoURL: photoURL,
        verified: false,
        createdAt: new Date().toISOString()
      });
      
      alert("‚úÖ Submitted for free verification! Wait for admin approval.");
      
      e.target.reset();
      cityGroup.style.display = "none";
      document.getElementById("otherGenderBox").style.display = "none";
      hideUsernamePreview();
      passwordStrength.style.display = "none";
      photoPreview.style.display = "none";
      defaultIcon.style.display = "block";
      userPhoto = null;
      
    } catch(err) {
      console.error("Submission error:", err);
      alert("‚ùå Error: " + err.message);
    }
  });

  window.addEventListener('load', function() {
    console.log('Signup form loaded successfully');
  });
</script>
